(()=>{"use strict";let e=JSON.parse(sessionStorage.getItem("joya-guardada")),t=[],n={nombre:"",foto:"",detalle:[]},o=document.getElementById("btnNuevoElementoReceta"),a=document.getElementById("inputNombre"),d=document.getElementById("inputFoto"),l=document.getElementById("btn-guardar"),i=JSON.parse(sessionStorage.getItem("id-usuario")),r=document.getElementById("tipos-habilitados");function c(e){let t=!1;return""==document.getElementById(e).value&&(t=!0),t}function u(e){let t=!0;return e.children.length>0&&(t=!1),t}function s(){for(let n=1;n<r.options.length;n++){var e=r.options[n];console.log(t),t.includes(parseInt(e.value))?e.disabled=!0:e.disabled=!1}}function p(e){let n=parseInt(e.cells[0].textContent.split(".")[0]);document.getElementById("detalle-receta").removeChild(e);let o=t.indexOf(n);t.splice(o),console.log(t)}(async function(e){try{const t="http://127.0.0.1:8000/api/joyas/"+e,n=await fetch(t);if(!n.ok)throw new Error("No se pudo obtener la joya");return await n.json()}catch(e){return e}})(e).then((function(e){a.value=e.nombre,d.value=e.foto,n.nombre=e.nombre,n.foto=e.foto})),async function(e){try{const t=await fetch("http://127.0.0.1:8000/api/recetas/"+e);if(!t.ok)throw new Error("No se pudo obtener las joyas");return await t.json()}catch(e){return!1}}(e).then((function(e){!function(e){let o=document.getElementById("detalle-receta");for(let a=0;a<e.detalle.length;a++){console.log(e.detalle[a]);let d=document.createElement("tr"),l=document.createElement("td"),i=document.createElement("span");i.textContent=e.detalle[a].id_componente+". "+e.detalle[a].tipo;let r=document.createElement("td"),c=document.createElement("input");c.value=e.detalle[a].cantidad_necesaria,c.setAttribute("type","number"),c.setAttribute("min","1");let u=document.createElement("td"),m=document.createElement("button");m.textContent="Eliminar",m.style.backgroundColor="red",m.addEventListener("click",(function(){p(d),s()}));let h={id_componente:e.detalle[a].id_componente,cantidad:e.detalle[a].cantidad_necesaria};t.push(parseInt(e.detalle[a].id_componente)),n.detalle.push(h),l.appendChild(i),r.appendChild(c),u.appendChild(m),d.appendChild(l),d.appendChild(r),d.appendChild(u),o.appendChild(d)}}(e)})),async function(){try{const e="http://127.0.0.1:8000/api/consultar/tipos",t=await fetch(e);if(!t.ok)throw new Error("No se pudo obtener las categorias");return await t.json()}catch(e){return e}}().then((function(e){!function(e){for(let t=0;t<e.tipos.length;t++){const n=document.createElement("option");n.value=e.tipos[t].id,n.textContent=n.value+". "+e.tipos[t].nombre,r.appendChild(n)}}(e),s()})),a.addEventListener("input",(function(){c(a.id)?o.disabled=!0:o.disabled=!1,c(d.id)||c(a.id)?(o.disabled=!0,l.disabled=!0):u(document.getElementById("detalle-receta"))||(l.disabled=!1)})),d.addEventListener("input",(function(){c(d.id)?o.disabled=!0:o.disabled=!1,c(d.id)||c(a.id)?(o.disabled=!0,l.disabled=!0):u(document.getElementById("detalle-receta"))||(l.disabled=!1)})),l.addEventListener("click",(function(){let t=document.getElementById("detalle-receta"),o={},l=[];o.nombre=a.value,o.foto=d.value,o.id_usuario=i,o.detalle=[];for(let e=0;e<t.rows.length;e++){let n=t.rows[e],a=parseInt(n.cells[1].querySelector("input").value),d=n.cells[0].textContent,i={};i.cantidad=parseInt(a),i.id_componente=d.split(".")[0],l.push(a),o.detalle.push(i)}if(0==o.detalle.length)alert("No puedes guardar una joya sin receta");else if(function(e){let t=!0,n=0;for(;n<e.length&&t;)e[n]<=0&&(t=!1),n++;return t}(l)){if(window.confirm("¿Estás seguro de que deseas actualizar esta joya?")){let t={joya_original:n,joya:o};console.log(JSON.stringify(t)),async function(e,t){try{let n="http://127.0.0.1:8000/api/joyas/"+e;const o={method:"PUT",headers:{"Content-Type":"aplication/json"},body:JSON.stringify(t)},a=await fetch(n,o);if(!a.ok)throw new Error("No se pudo actualizar");return await a.json()}catch(e){return e}}(e,t).then((function(){window.location.href="listaJoyasUsuario.html"}))}}else alert("Debes introducir cantidades correctas")})),o.addEventListener("click",(function(){let e=document.getElementById("tipos-habilitados").value,n=document.getElementById("inputCantidad").value,o=[!0],a="";if((""==n||n.includes("-")||"0"==n)&&(a+=" Debe introducir una cantidad \n",o.push(!1)),0==e&&(a+=" Debe introducir elegir un tipo \n",o.push(!1)),o.includes(!1))alert(a);else{let e=document.getElementById("detalle-receta"),o=document.createElement("tr"),a=document.createElement("td"),d=document.createElement("input");d.setAttribute("type","number"),d.setAttribute("min","1"),d.value=n;let i=document.createElement("td"),r=document.getElementById("tipos-habilitados"),c=r.selectedIndex,u=r.options[c].textContent,m=document.createElement("td"),h=document.createElement("button");h.textContent="Eliminar",h.style.backgroundColor="red",h.addEventListener("click",(function(){p(o),s()})),t.push(parseInt(r.value)),r.options[c].disabled=!0,document.getElementById("opcion-default").selected=!0;let f=document.createElement("span");f.textContent=u,i.appendChild(f),a.appendChild(d),m.appendChild(h),o.appendChild(i),o.appendChild(a),o.appendChild(m),e.appendChild(o),l.disabled=!1}}))})();