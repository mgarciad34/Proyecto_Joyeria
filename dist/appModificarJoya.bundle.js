(()=>{"use strict";let e=JSON.parse(sessionStorage.getItem("joya-guardada")),t=[],n={nombre:"",foto:"",detalle:[]},o=document.getElementById("btnNuevoElementoReceta"),d=document.getElementById("inputNombre"),a=document.getElementById("inputFoto"),l=document.getElementById("btn-guardar"),i=JSON.parse(sessionStorage.getItem("id-usuario")),c=document.getElementById("tipos-habilitados");function r(e){let t=!1;return""==document.getElementById(e).value&&(t=!0),t}function u(e){let t=!0;return e.children.length>0&&(t=!1),t}function s(){for(let n=1;n<c.options.length;n++){var e=c.options[n];console.log(t),t.includes(parseInt(e.value))?e.disabled=!0:e.disabled=!1}}function p(e){let n=parseInt(e.cells[0].textContent.split(".")[0]);document.getElementById("detalle-receta").removeChild(e);let o=t.indexOf(n);t.splice(o),console.log(t)}(async function(e){try{const t="http://127.0.0.1:8000/api/joyas/"+e,n=await fetch(t);if(!n.ok)throw new Error("No se pudo obtener la joya");return await n.json()}catch(e){return e}})(e).then((function(e){d.value=e.nombre,a.value=e.foto,n.nombre=e.nombre,n.foto=e.foto})),async function(e){try{const t=await fetch("http://127.0.0.1:8000/api/recetas/"+e);if(!t.ok)throw new Error("No se pudo obtener las joyas");return await t.json()}catch(e){return!1}}(e).then((function(e){!function(e){let o=document.getElementById("detalle-receta");for(let d=0;d<e.detalle.length;d++){console.log(e.detalle[d]);let a=document.createElement("tr"),l=document.createElement("td"),i=document.createElement("span");i.textContent=e.detalle[d].id_componente+". "+e.detalle[d].tipo;let c=document.createElement("td"),r=document.createElement("input");r.value=e.detalle[d].cantidad_necesaria;let u=document.createElement("td"),m=document.createElement("button");m.textContent="Eliminar",m.style.backgroundColor="red",m.addEventListener("click",(function(){p(a),s()}));let h={id_componente:e.detalle[d].id_componente,cantidad:e.detalle[d].cantidad_necesaria};t.push(parseInt(e.detalle[d].id_componente)),n.detalle.push(h),l.appendChild(i),c.appendChild(r),u.appendChild(m),a.appendChild(l),a.appendChild(c),a.appendChild(u),o.appendChild(a)}}(e)})),async function(){try{const e="http://127.0.0.1:8000/api/consultar/tipos",t=await fetch(e);if(!t.ok)throw new Error("No se pudo obtener las categorias");return await t.json()}catch(e){return e}}().then((function(e){!function(e){for(let t=0;t<e.tipos.length;t++){const n=document.createElement("option");n.value=e.tipos[t].id,n.textContent=n.value+". "+e.tipos[t].nombre,c.appendChild(n)}}(e),s()})),d.addEventListener("input",(function(){r(d.id)?o.disabled=!0:o.disabled=!1,r(a.id)||r(d.id)?(o.disabled=!0,l.disabled=!0):u(document.getElementById("detalle-receta"))||(l.disabled=!1)})),a.addEventListener("input",(function(){r(a.id)?o.disabled=!0:o.disabled=!1,r(a.id)||r(d.id)?(o.disabled=!0,l.disabled=!0):u(document.getElementById("detalle-receta"))||(l.disabled=!1)})),l.addEventListener("click",(function(){let t=document.getElementById("detalle-receta"),o={};o.nombre=d.value,o.foto=a.value,o.id_usuario=i,o.detalle=[];for(let e=0;e<t.rows.length;e++){let n=t.rows[e],d=n.cells[1].textContent,a=n.cells[0].textContent,l={};l.cantidad=d,l.tipo=a.split(".")[0],o.detalle.push(l)}0==o.detalle.length?alert("No puedes guardar una joya sin receta"):window.confirm("¿Estás seguro de que deseas actualizar esta joya?")&&async function(e,t){try{let n="http://127.0.0.1:8000/api/joyas/"+e;const o={method:"PUT",headers:{"Content-Type":"aplication/json"},body:JSON.stringify(t)},d=await fetch(n,o);if(!d.ok)throw new Error("No se pudo actualizar");return await d.json()}catch(e){return e}}(e,{joya_original:n,joya:o}).then((function(){window.location.href="listaJoyasUsuario.html"}))})),o.addEventListener("click",(function(){let e=document.getElementById("tipos-habilitados").value,n=document.getElementById("inputCantidad").value,o=[!0],d="";if((""==n||n.includes("-")||"0"==n)&&(d+=" Debe introducir una cantidad \n",o.push(!1)),0==e&&(d+=" Debe introducir elegir un tipo \n",o.push(!1)),o.includes(!1))alert(d);else{let e=document.getElementById("detalle-receta"),o=document.createElement("tr"),d=document.createElement("td"),a=document.createElement("input");a.value=n;let i=document.createElement("td"),c=document.getElementById("tipos-habilitados"),r=c.selectedIndex,u=c.options[r].textContent,m=document.createElement("td"),h=document.createElement("button");h.textContent="Eliminar",h.style.backgroundColor="red",h.addEventListener("click",(function(){p(o),s()})),t.push(parseInt(c.value)),c.options[r].disabled=!0,document.getElementById("opcion-default").selected=!0;let E=document.createElement("span");E.textContent=u,i.appendChild(E),d.appendChild(a),m.appendChild(h),o.appendChild(i),o.appendChild(d),o.appendChild(m),e.appendChild(o),l.disabled=!1}}))})();