(()=>{"use strict";let e=JSON.parse(sessionStorage.getItem("joya-guardada")),t=[],n={nombre:"",foto:"",detalle:[]},d=document.getElementById("btnNuevoElementoReceta"),o=document.getElementById("inputNombre"),l=document.getElementById("inputFoto"),a=document.getElementById("btn-guardar"),i=JSON.parse(sessionStorage.getItem("id-usuario")),c=document.getElementById("tipos-habilitados");function r(e){let t=!1;return""==document.getElementById(e).value&&(t=!0),t}function u(e){let t=!0;return e.children.length>0&&(t=!1),t}function s(){for(let n=1;n<c.options.length;n++){var e=c.options[n];console.log(t),t.includes(parseInt(e.value))?e.disabled=!0:e.disabled=!1}}function m(e){let n=parseInt(e.cells[0].textContent.split(".")[0]);document.getElementById("detalle-receta").removeChild(e);let d=t.indexOf(n);t.splice(d),console.log(t)}(async function(e){try{const t="http://127.0.0.1:8000/api/joyas/"+e,n=await fetch(t);if(!n.ok)throw new Error("No se pudo obtener la joya");return await n.json()}catch(e){return e}})(e).then((function(e){o.value=e.nombre,l.value=e.foto,n.nombre=e.nombre,n.foto=e.foto})),async function(e){try{const t=await fetch("http://127.0.0.1:8000/api/recetas/"+e);if(!t.ok)throw new Error("No se pudo obtener las joyas");return await t.json()}catch(e){return!1}}(e).then((function(e){!function(e){let d=document.getElementById("detalle-receta");for(let o=0;o<e.detalle.length;o++){console.log(e.detalle[o]);let l=document.createElement("tr"),a=document.createElement("td"),i=document.createElement("span");i.textContent=e.detalle[o].id_componente+". "+e.detalle[o].tipo;let c=document.createElement("td"),r=document.createElement("input");r.value=e.detalle[o].cantidad_necesaria;let u=document.createElement("td"),p=document.createElement("button");p.textContent="Eliminar",p.style.backgroundColor="red",p.addEventListener("click",(function(){m(l),s()}));let h={id_componente:e.detalle[o].id_componente,cantidad:e.detalle[o].cantidad_necesaria};t.push(parseInt(e.detalle[o].id_componente)),n.detalle.push(h),a.appendChild(i),c.appendChild(r),u.appendChild(p),l.appendChild(a),l.appendChild(c),l.appendChild(u),d.appendChild(l)}}(e)})),async function(){try{const e="http://127.0.0.1:8000/api/consultar/tipos",t=await fetch(e);if(!t.ok)throw new Error("No se pudo obtener las categorias");return await t.json()}catch(e){return e}}().then((function(e){!function(e){for(let t=0;t<e.tipos.length;t++){const n=document.createElement("option");n.value=e.tipos[t].id,n.textContent=n.value+". "+e.tipos[t].nombre,c.appendChild(n)}}(e),s()})),o.addEventListener("input",(function(){r(o.id)?d.disabled=!0:d.disabled=!1,r(l.id)||r(o.id)?(d.disabled=!0,a.disabled=!0):u(document.getElementById("detalle-receta"))||(a.disabled=!1)})),l.addEventListener("input",(function(){r(l.id)?d.disabled=!0:d.disabled=!1,r(l.id)||r(o.id)?(d.disabled=!0,a.disabled=!0):u(document.getElementById("detalle-receta"))||(a.disabled=!1)})),a.addEventListener("click",(function(){let e=document.getElementById("detalle-receta"),t={};t.nombre=o.value,t.foto=l.value,t.id_usuario=i,t.detalle=[];for(let n=0;n<e.rows.length;n++){let d=e.rows[n],o=d.cells[1].textContent,l=d.cells[0].textContent,a={};a.cantidad=o,a.tipo=l.split(".")[0],t.detalle.push(a)}window.confirm("¿Estás seguro de que deseas guardar esta joya?")&&(console.log(JSON.stringify(t)),guardarNuevaJoya(t).then((function(){document.getElementById("inputNombre").value="",document.getElementById("inputFoto").value="",window.location.href="listaJoyas.html"})))})),d.addEventListener("click",(function(){let e=document.getElementById("tipos-habilitados").value,n=document.getElementById("inputCantidad").value,d=[!0],o="";if((""==n||n.includes("-")||"0"==n)&&(o+=" Debe introducir una cantidad \n",d.push(!1)),0==e&&(o+=" Debe introducir elegir un tipo \n",d.push(!1)),d.includes(!1))alert(o);else{let e=document.getElementById("detalle-receta"),d=document.createElement("tr"),o=document.createElement("td"),l=document.createElement("input");l.value=n;let i=document.createElement("td"),c=document.getElementById("tipos-habilitados"),r=c.selectedIndex,u=c.options[r].textContent,p=document.createElement("td"),h=document.createElement("button");h.textContent="Eliminar",h.style.backgroundColor="red",h.addEventListener("click",(function(){m(d),s()})),t.push(parseInt(c.value)),c.options[r].disabled=!0,document.getElementById("opcion-default").selected=!0;let E=document.createElement("span");E.textContent=u,i.appendChild(E),o.appendChild(l),p.appendChild(h),d.appendChild(i),d.appendChild(o),d.appendChild(p),e.appendChild(d),a.disabled=!1}}))})();