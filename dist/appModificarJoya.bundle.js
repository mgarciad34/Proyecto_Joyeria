(()=>{"use strict";let e=JSON.parse(sessionStorage.getItem("joya-guardada")),t=[],n={nombre:"",foto:"",detalle:[]},d=document.getElementById("btnNuevoElementoReceta"),l=document.getElementById("inputNombre"),o=document.getElementById("inputFoto"),a=document.getElementById("btn-guardar"),i=JSON.parse(sessionStorage.getItem("id-usuario")),c=document.getElementById("tipos-habilitados");function r(e){let t=!1;return""==document.getElementById(e).value&&(t=!0),t}function u(e){let t=!0;return e.children.length>0&&(t=!1),t}function s(){for(let n=1;n<c.options.length;n++){var e=c.options[n];console.log(t),t.includes(parseInt(e.value))?e.disabled=!0:e.disabled=!1}}function p(e){let n=parseInt(e.cells[0].textContent.split(".")[0]);document.getElementById("detalle-receta").removeChild(e);let d=t.indexOf(n);t.splice(d),console.log(t)}(async function(e){try{const t="http://127.0.0.1:8000/api/joyas/"+e,n=await fetch(t);if(!n.ok)throw new Error("No se pudo obtener la joya");return await n.json()}catch(e){return e}})(e).then((function(e){l.value=e.nombre,o.value=e.foto,n.nombre=e.nombre,n.foto=e.foto})),async function(e){try{const t=await fetch("http://127.0.0.1:8000/api/recetas/"+e);if(!t.ok)throw new Error("No se pudo obtener las joyas");return await t.json()}catch(e){return!1}}(e).then((function(e){!function(e){let d=document.getElementById("detalle-receta");for(let l=0;l<e.detalle.length;l++){console.log(e.detalle[l]);let o=document.createElement("tr"),a=document.createElement("td"),i=document.createElement("span");i.textContent=e.detalle[l].id_componente+". "+e.detalle[l].tipo;let c=document.createElement("td"),r=document.createElement("input");r.value=e.detalle[l].cantidad_necesaria,r.setAttribute("type","number"),r.setAttribute("min","1");let u=document.createElement("td"),m=document.createElement("button");m.textContent="Eliminar",m.style.backgroundColor="red",m.addEventListener("click",(function(){p(o),s()}));let h={id_componente:e.detalle[l].id_componente,cantidad:e.detalle[l].cantidad_necesaria};t.push(parseInt(e.detalle[l].id_componente)),n.detalle.push(h),a.appendChild(i),c.appendChild(r),u.appendChild(m),o.appendChild(a),o.appendChild(c),o.appendChild(u),d.appendChild(o)}}(e)})),async function(){try{const e="http://127.0.0.1:8000/api/consultar/tipos",t=await fetch(e);if(!t.ok)throw new Error("No se pudo obtener las categorias");return await t.json()}catch(e){return e}}().then((function(e){!function(e){for(let t=0;t<e.tipos.length;t++){const n=document.createElement("option");n.value=e.tipos[t].id,n.textContent=n.value+". "+e.tipos[t].nombre,c.appendChild(n)}}(e),s()})),l.addEventListener("input",(function(){r(l.id)?d.disabled=!0:d.disabled=!1,r(o.id)||r(l.id)?(d.disabled=!0,a.disabled=!0):u(document.getElementById("detalle-receta"))||(a.disabled=!1)})),o.addEventListener("input",(function(){r(o.id)?d.disabled=!0:d.disabled=!1,r(o.id)||r(l.id)?(d.disabled=!0,a.disabled=!0):u(document.getElementById("detalle-receta"))||(a.disabled=!1)})),a.addEventListener("click",(function(){let e=document.getElementById("detalle-receta"),t={},d=[];t.nombre=l.value,t.foto=o.value,t.id_usuario=i,t.detalle=[];for(let n=0;n<e.rows.length;n++){let l=e.rows[n],o=parseInt(l.cells[1].querySelector("input").value),a=l.cells[0].textContent,i={};i.cantidad=parseInt(o),i.id_componente=a.split(".")[0],d.push(o),t.detalle.push(i)}if(0==t.detalle.length)alert("No puedes guardar una joya sin receta");else if(function(e){let t=!0,n=0;for(;n<e.length&&t;)e[n]<=0&&(t=!1),n++;return t}(d)){if(window.confirm("¿Estás seguro de que deseas actualizar esta joya?")){let e={joya_original:n,joya:t};console.log(JSON.stringify(e))}}else alert("Debes introducir cantidades correctas")})),d.addEventListener("click",(function(){let e=document.getElementById("tipos-habilitados").value,n=document.getElementById("inputCantidad").value,d=[!0],l="";if((""==n||n.includes("-")||"0"==n)&&(l+=" Debe introducir una cantidad \n",d.push(!1)),0==e&&(l+=" Debe introducir elegir un tipo \n",d.push(!1)),d.includes(!1))alert(l);else{let e=document.getElementById("detalle-receta"),d=document.createElement("tr"),l=document.createElement("td"),o=document.createElement("input");o.setAttribute("type","number"),o.setAttribute("min","1"),o.value=n;let i=document.createElement("td"),c=document.getElementById("tipos-habilitados"),r=c.selectedIndex,u=c.options[r].textContent,m=document.createElement("td"),h=document.createElement("button");h.textContent="Eliminar",h.style.backgroundColor="red",h.addEventListener("click",(function(){p(d),s()})),t.push(parseInt(c.value)),c.options[r].disabled=!0,document.getElementById("opcion-default").selected=!0;let E=document.createElement("span");E.textContent=u,i.appendChild(E),l.appendChild(o),m.appendChild(h),d.appendChild(i),d.appendChild(l),d.appendChild(m),e.appendChild(d),a.disabled=!1}}))})();